<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style text="text/css">
    #result div {
      background-color: lightgrey;
      display: inline-block;
      margin: 5px;
    }
    #result button {
      margin: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mood test</h1>
    <div class="form-group">
      <label for"text">Text:</label>
      <input id="text" class="form-control" autocomplete="off" />
    </div>
    <button id="classify" class="btn btn-primary">classify</button>
  </div>
  <hr/>
  <div class="container">
    <div id="sentiment" class=form-group"></div>
  </div>
  <hr/>
  <div class="container">
    <div id="mood" class=form-group"></div>
  </div>

  <script type="text/javascript">
    function request(url, data) {
      var settings = {
        "url": url,
        "method": "POST",
        "timeout": 0,
        "dataType": "json",
        "headers": {
          "Authorization": "Basic c2NpbGluZzpzY2lsaW5n",
          "Content-Type": "application/json",
        },
        "data": JSON.stringify(data),
      };

      return $.ajax(settings);
    }

    function setResponse(id) {
      return function (response) {
        let $result = $("#" + id);
        $result.empty();
        console.log('response', response)
        response.result.forEach(function(e, i) {
          let $button = $('<button class="btn"></button>');
          $button.attr('id', e[0]);
          $button.html(e[0] + ": " + e[1].toFixed(2));
          $button.addClass(i==0?'btn-success':'btn-danger');
          $button.click(fixLabel(id, e[0]));
          $result.append($button);
        });
      }
    }


    function classify(id) {
      return function() {
        var sentence = $('#text').val();
        console.log('SENTENCE:', sentence);

        return request("/" + id, {"text": sentence})
        .done(setResponse(id));
      }
    }

    function fixLabel(id, name) {
      return function() {
        var sentence = $('#text').val();
        console.log('fix', sentence, name);

        return request("/" + id + "-fix", {"text": sentence, "label": name})
        .done(function (response) {
          console.log('Done', response);
          return classify(id);
        });
      }
    }

    function doClick() {
      classify('sentiment')()
      .then(classify('mood'));
    }

    $('#classify').click(doClick);

    $('#text').keypress(function(e) {
      if (e.which == 13) doClick();
    });

  </script>


</body>
</html>
